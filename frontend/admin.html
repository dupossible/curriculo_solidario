<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin ‚Äî Curr√≠culo Solid√°rio</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="styles.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<nav class="navbar navbar-light bg-white border-bottom px-3">
  <span class="navbar-brand mb-0 h1 text-primary">Painel da Gr√°fica</span>
  <button id="logout" class="btn btn-outline-secondary btn-sm">Sair</button>
</nav>

<div class="container py-4">
  
  <div class="input-group mb-3">
    <input id="searchCode" class="form-control" placeholder="Digite o c√≥digo de impress√£o">
    <button id="btnFind" class="btn btn-primary">Buscar</button>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-secondary" onclick="loadAll()">Listar todos</button>
    <button class="btn btn-outline-secondary" onclick="clearList()">Limpar lista</button>
  </div>

  <!-- resultado de busca individual -->
  <div id="result" class="mb-3"></div>

  <!-- tabela de todos os curr√≠culos -->
  <div class="table-responsive">
    <table class="table table-striped align-middle mb-0" id="tblAll" style="display:none;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>C√≥digo</th>
          <th>E-mail</th>
          <th style="width:220px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tblAllBody"></tbody>
    </table>
  </div>

</div>
<script>
// Detecta local vs produ√ß√£o automaticamente
const API = (
  location.hostname === "localhost" ||
  location.hostname === "127.0.0.1"
)
  ? "http://localhost:5000"
  : "https://curriculo-solidario.onrender.com";

// Logout
document.getElementById('logout').onclick = () => {
  window.location.href = 'login-admin.html';
};

// üîç Buscar por c√≥digo (j√° existia)
document.getElementById('btnFind').onclick = async () => {
  const code = document.getElementById('searchCode').value.trim();
  if (!code) return;

  clearList();

  const r = await fetch(`${API}/api/cv/by-code/${code}`);
  const data = await r.json();

  if (!data.ok) {
    Swal.fire('N√£o encontrado', '', 'warning');
    return;
  }

  const cv = data.cv;
  document.getElementById('result').innerHTML = `
    <div class="card card-elev p-3">
      <div><strong>Nome:</strong> ${cv.name}</div>
      <div><strong>E-mail:</strong> ${cv.email}</div>
      <div><strong>Telefone:</strong> ${cv.phone}</div>
      <div class="mt-2">
        <a href="${API}/api/cv/${cv.printCode}/pdf" target="_blank"
           class="btn btn-success me-2">Baixar PDF</a>
      </div>
    </div>
  `;
};

// üìå NOVO ‚Äî Listar todos os curr√≠culos
async function loadAll() {
  document.getElementById('result').innerHTML = '';

  try {
    const r = await fetch(`${API}/api/cv/all`);
    const data = await r.json();

    if (!data.ok) throw new Error(data.error);
    renderAllTable(data.data);
  } catch (err) {
    Swal.fire('Erro', err.message, 'error');
  }
}

// üìå NOVO ‚Äî Renderizar tabela de todos
function renderAllTable(list) {
  const table = document.getElementById('tblAll');
  const body = document.getElementById('tblAllBody');
  body.innerHTML = '';

  if (!list.length) {
    table.style.display = 'none';
    Swal.fire('Aviso', 'Nenhum curr√≠culo encontrado.', 'info');
    return;
  }

  list.forEach(cv => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(cv.name || '')}</td>
      <td><code>${cv.printCode}</code></td>
      <td>${escapeHtml(cv.email || '')}</td>
      <td>
        <a class="btn btn-success btn-sm me-2" target="_blank"
           href="${API}/api/cv/${cv.printCode}/pdf">Baixar PDF</a>
        <button class="btn btn-outline-primary btn-sm"
           onclick="copyCode('${cv.printCode}')">Copiar C√≥digo</button>
      </td>
    `;
    body.appendChild(tr);
  });

  table.style.display = '';
}

// üìå NOVO ‚Äî Limpar lista
function clearList() {
  document.getElementById('tblAllBody').innerHTML = '';
  document.getElementById('tblAll').style.display = 'none';
}

// Copiar c√≥digo para √°rea de transfer√™ncia
function copyCode(code) {
  navigator.clipboard?.writeText(code).then(() => {
    Swal.fire({
      icon: 'success',
      title: 'Copiado!',
      text: `C√≥digo ${code} copiado.`,
      timer: 1200,
      showConfirmButton: false
    });
  });
}

// Previne quebra de HTML
function escapeHtml(str = '') {
  return str.replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;',
    '"': '&quot;', "'": '&#39;'
  }[m]));
}
</script>
</body>
</html>
